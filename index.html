<html>
<head>
	<meta charset="utf-8">
	<title>Hello World!</title>
</head>
	<style>* {padding: 0; margin: 0}</style>
	<script src="libs/js/pixi.min.js"></script>
<body>
	<script type="text/javascript">
		let type="WebGL"
		if(!PIXI.utils.isWebGLSupported()){
			type = "canvas"
		}

		PIXI.utils.sayHello(type)

		let WIDTH = 256;
		let HEIGHT = 256;
		let app = new PIXI.Application({width:WIDTH, height:HEIGHT});
		let loader = PIXI.loader,
				Sprite = PIXI.Sprite,
				resources = PIXI.loader.resources;

		document.body.appendChild(app.view);

		app.renderer.view.style.position = "absolute";
		app.renderer.view.style.display = "block";
		app.renderer.autoResize = true;
		//app.renderer.resize(window.innerWidth, window.innerHeight);

		loader
			.add("ship","libs/images/ship.png")
			.add("ship2","libs/images/ship2.png")
			.add("enemy","libs/images/sprites.json")
			.on("progress",loadProgressHandler)
			.load(setup);

		let sship;
		let enemy1,enemy2,enemy3,enemy4;
		let message
		let line;
		let lk=0,
		rk=0,
		uk=0,
		dk=0;

		function loadProgressHandler(loader,resource){

			console.log("loading: " + resource.url);

			console.log("progress: " + loader.progress + "%");
		}

		function setup(){

			let style = new PIXI.TextStyle({
				fill:'#ffffff'
			});
			message = new PIXI.Text("Hello There!",style);
			message.position.set(0,0);

			line = new PIXI.Graphics();
			app.stage.addChild(line);


			sship = new Sprite(resources.ship.texture);
			enemy1 = new Sprite(resources.enemy.textures["enemy1.png"]);
			enemy2 = new Sprite(resources.enemy.textures["enemy2.png"]);
			enemy3 = new Sprite(resources.enemy.textures["enemy3.png"]);
			enemy4 = new Sprite(resources.enemy.textures["enemy4.png"]);
			enemy5 = new Sprite(resources.enemy.textures["enemy5.png"]);

			let enemies = new PIXI.Container();
			enemies.addChild(enemy1);
			enemies.addChild(enemy2);
			enemies.addChild(enemy3);
			enemies.addChild(enemy4);
			enemies.addChild(enemy5);


			app.stage.addChild(sship);
			app.stage.addChild(enemies);
			app.stage.addChild(message);


		 for(let i=0; i< enemies.children.length; i++){
			  enemies.children[i].position.set(randomInt( 0,WIDTH-32), randomInt( 0, HEIGHT-32));
				//enemies.children[i].rotation = Math.random() * 3.14;
			}

			sship.position.set(100,100);
			sship.vx = 0;
			sship.vy = 0;


			let spd=5;

			let left = keyboard("ArrowLeft"),
					up = keyboard("ArrowUp"),
					right = keyboard("ArrowRight"),
					down = keyboard("ArrowDown");

			left.press = () => {
				lk=-spd;
			}
			right.press = () => {
				rk=spd;
			}
			up.press = () => {
				uk=-spd;
			}
			down.press = () => {
				dk=spd;
			}

			left.release = () => {
				lk=0;
			}
			right.release = () => {
				rk=0;
			}
			up.release = () => {
			  uk=0;
			}
			down.release = () => {
				dk=0;
			}





			app.ticker.add(delta=>gameLoop(delta));

		}

		let state=play;

		function gameLoop(delta){
			state(delta);

		}

		function play(delta){
			sship.vx = lk + rk;
			sship.vy = uk + dk;
			sship.x += sship.vx;
			sship.y += sship.vy;
			//line.x=sship.x;
			//line.y=sship.y;
			if(hitTestRectangle(sship,enemy1)){
				message.text = "hitting";
			}else{

				message.text = "not";
			}
			//sship.rotation += .1*delta;
		}

		function randomInt(min, max) {
		  return Math.floor(Math.random() * (max - min + 1)) + min;
		}

		function hitTestRectangle(r1, r2) {

		  //Define the variables we'll need to calculate
		  let hit, combinedHalfWidths, combinedHalfHeights, vx, vy;

		  //hit will determine whether there's a collision
		  hit = false;

		  //Find the center points of each sprite
		  r1.centerX = r1.getGlobalPosition().x + r1.width / 2;
		  r1.centerY = r1.getGlobalPosition().y + r1.height / 2;
		  r2.centerX = r2.getGlobalPosition().x + r2.width / 2;
		  r2.centerY = r2.getGlobalPosition().y + r2.height / 2;

		  //Find the half-widths and half-heights of each sprite
		  r1.halfWidth = r1.width / 2;
		  r1.halfHeight = r1.height / 2;
		  r2.halfWidth = r2.width / 2;
		  r2.halfHeight = r2.height / 2;

		  //Calculate the distance vector between the sprites
		  vx = r1.centerX - r2.centerX;
		  vy = r1.centerY - r2.centerY;
				line.clear();
				line.lineStyle(4, 0xFFFFFF, 1);
			 line.moveTo(r1.centerX,r1.centerY);
			 line.lineTo(r2.centerX,r2.centerY);

		  //Figure out the combined half-widths and half-heights
		  combinedHalfWidths = r1.halfWidth + r2.halfWidth;
		  combinedHalfHeights = r1.halfHeight + r2.halfHeight;

		  //Check for a collision on the x axis
		  if (Math.abs(vx) < combinedHalfWidths) {

		    //A collision might be occurring. Check for a collision on the y axis
		    if (Math.abs(vy) < combinedHalfHeights) {

		      //There's definitely a collision happening
		      hit = true;
		    } else {

		      //There's no collision on the y axis
		      hit = false;
		    }
		  } else {

		    //There's no collision on the x axis
		    hit = false;
		  }

		  //`hit` will be either `true` or `false`
		  return hit;
		};

		function keyboard(value) {
		  let key = {};
		  key.value = value;
		  key.isDown = false;
		  key.isUp = true;
		  key.press = undefined;
		  key.release = undefined;
		  //The `downHandler`
		  key.downHandler = event => {
		    if (event.key === key.value) {
		      if (key.isUp && key.press) key.press();
		      key.isDown = true;
		      key.isUp = false;
		      event.preventDefault();
		    }
		  };

		  //The `upHandler`
		  key.upHandler = event => {
		    if (event.key === key.value) {
		      if (key.isDown && key.release) key.release();
		      key.isDown = false;
		      key.isUp = true;
		      event.preventDefault();
		    }
		  };

		  //Attach event listeners
		  const downListener = key.downHandler.bind(key);
		  const upListener = key.upHandler.bind(key);

		  window.addEventListener(
		    "keydown", downListener, false
		  );
		  window.addEventListener(
		    "keyup", upListener, false
		  );

		  // Detach event listeners
		  key.unsubscribe = () => {
		    window.removeEventListener("keydown", downListener);
		    window.removeEventListener("keyup", upListener);
		  };

		  return key;
		}

	</script>

</body>
</html>
